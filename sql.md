SQL 第2版 ゼロから始めるデータベース操作

# 第0章 イントロダクション
macでのpostgresqlインストール
- [この記事](https://qiita.com/ksh-fthr/items/b86ba53f8f0bccfd7753)を参照

設定後のログイン
```
psql -Upostgres
```

DBの作成、psqlの終了
```
postgres=# CREATE DATABASE shop;
CREATE DATABASE
postgres=# \q
```

学習用データベースshopへのログイン
```
% psql -Upostgres -dshop
psql (13.1)
Type "help" for help.

shop=#
```
後の章ではこのDBでSQLを実行していく。

# 第1章 データベースとSQL

## 1-1 データベースとは何か
- 大量の情報を保存し、コンピュータから効率よくアクセスできるように加工したデータの集まりのことを「データベース」と呼ぶ。
- データベースを管理するコンピュータシステムのことを、「データベース管理システム（DBMS）」と呼ぶ。
- DBMSを使うことにより、大量のデータを多人数でも安全かつ簡単に扱える。
- 本書では「リレーショナルデータベース（RDB）」を「SQL」という専門言語で操作する方法を学ぶ。RDBは「リレーショナルデータベース管理システム（RDBMS）」で管理する。

## 1-2 データベースの構成
- RDBMSは一般に、「クライアント／サーバ型」のシステム構成で使用される。
- RDBMSはサーバの一種で、ハードディスクに保存されているデータベースからデータを取り出して返したり、指示された内容でデータを書き換えたりする。
- RDBMSのクライアント（サーバに要求を出すプログラム）は、サーバであるRDBMSにSQL文を送信する。RDBMSはその文の内容に従ってデータを返信したりする。
- **SQL文の内容に従ってクライアントに返信されるデータも、必ずテーブルと同じように2次元表の形になる。**
- **RDBでは、必ず行単位でデータを読み書きする。**
- 行と列が交わる1つのマス目を、本書ではセルと呼ぶ。**1つのセルの中には、1つのデータしか入れられない。**

## 1-3 SQLの概要
- SQLにはISOで定められた標準規格があり、それに準拠したSQLを**標準SQL**と呼ぶ。最近は様々なRDBMSで標準SQLのサポートが進んでいるので、標準SQLの書き方を覚えると良い。（本書も標準SQLでの書き方を解説する。）
- SQL文は、RDBMSに与える命令の種類により、次の3つに分類される。最も使われるのはDML。
  - DDL（データ定義言語） CREATE, DROP, ALTER
  - DML（データ操作言語） SELECT, INSERT, UPDATE, DELETE
  - DCL（データ制御言語） COMMIT, ROLLBACK, GRANT, REVOKE
- SQL文の書き方にはいくつかの決まりがある。
  - SQL文の最後にセミコロンをつける。
  - キーワードの大文字・小文字は区別されない。
  - 定数の書き方には決まりがある。
    - SQL文の中に直に書く文字列や日付、数値などを定数と呼ぶ。
    - 文字列はシングルクォーテーションで囲む。数値は何かの記号で囲む必要はない。
  - 単語は半角スペースか改行で区切る。

## 1-4 テーブルの作成
- RDBMS上にデータベースを作成するSQL文
```
CREATE DATABASE <データベース名>;
```
- テーブルの作成
```
CREATE TABLE <テーブル名>
(<列名1> <データ型> <この列の制約>,
 <列名2> <データ型> <この列の制約>,
 <列名3> <データ型> <この列の制約>
 ...
 <このテーブルの制約1>, <このテーブルの制約2>, ...);
```
- DBやテーブル、列などの名前に使って良い文字は、半角のアルファベット、半角数字、アンダーバーのみである。
- 名前の最初の文字は「半角のアルファベット」にする。
- 名前は重複してはならない。（1つのデータベースに同じ名前のテーブルを2つは作れない）

### データ形
- CHAR型：　固定長文字列　CHAR(8)などで最大文字数を指定する。格納する文字数が最大長に満たない場合は、空白スペースで埋める
- VARCHAR型：　可変長文字列　格納する文字数が最大長に満たなくても、そのまま格納する。

### キー
- キーとは、特定のデータを指定するときに使う列の組み合わせのこと。
- 主キーは1つの行を特定できる列のこと。主キー制約を設定すると、その列には重複した値を格納できない。

## 1-5 テーブルの削除と変更

### テーブルの削除
```
DROP TABLE <テーブル名>;
```
- **削除したテーブルは復活できないので、実行前によく確認すること。**

### テーブル定義の変更
- 後からテーブルの定義を変更するにはALTER TABLE文を使う。
- 列を追加する場合
```
ALTER TABLE <テーブル名> ADD COLUMN <列の定義>;
```
- **テーブル定義を変更したら元に戻せないので注意**

# 第2章 検索の基本

## 2-1 SELECT文の基本
- テーブルからデータを取り出すときはSELECT文を使う。
- 基本的なSELECT文
```
SELECT <列名>, ...
  FROM <テーブル名>;
```
- SELECT文にはSELECT句とFROM句という2つの「**句**」がある。句はSQL文を構成する要素で、SELECTやFROMなどのキーワードから始まるフレーズ。

### 列に別名をつける
- SQL文では、ASキーワードを使って、列に別名をつけられる。別名はSELECT文の実行結果を見やすくしたり扱いやすくするために使う。
- 別名には日本語を使うこともできる。その場合は、別名をダブルクォーテーションで囲む。

### 結果から重複行を省く
- 重複業を省いて結果を得たいときは、DISTINCTというキーワードを使う。
```
例：
SELECT DISTINCT shohin_bunrui
  FROM Shohin;
```
- DISTINCTは複数列の前にも置くことができる。この場合、複数の列を組み合わせてもなお重複する行が1つにまとめられる。
- DISTINCTは先頭の列名の前にしか書けない。

### WHERE句
- SELECT文では、選択したい行の条件をWHERE句で指定する。
```
SELECT <列名>, ...
  FROM <テーブル名>
  WHERE <条件式>;

例：
SELECT shohin_mei, shohin_bunrui
  FROM Shohin
  WHERE shohin_bunrui = '衣服';
```
- 実行順としては、WHERE句で指定した条件に合う行をまず選択し、その後にSELECT句で指定された列を出力する。
- SQLでは句の記述順が決まっており、勝手に変えることはできない。WHERE句はFROM句の直後に置く。

## 2-2 算術演算子と比較演算子
- SELECT句には計算式も書ける。演算は行ごとに行われる。
### 算術演算子
- 四則演算を行う記号は算術演算子と呼ばれる。
- NULLを含んだ計算は、問答無用でNULLになるので注意。
  - 5 + NULL = 5 という結果が欲しいケースに対応する方法も用意されている（6-1節）

### 比較演算子
- =記号のように、両辺に記述した列や値を比較する記号のことを比較演算子とよぶ。
- 以上（>=）あるいは以下（<=）は、必ず不等号が左側、イコールが右側になるように書く。
- 文字列型の順序の原則は辞書式。数値の大小順序と混同してはいけない。
  - 例： 文字列型では次のような順序になる。　1, 10, 11, 2, 222, 3
- NULLである行を選択したい時は、条件式にIS NULL演算子を使う。NULLでない行を選択したい場合は、IS NOT NULL演算子を使う。

## 2-3 論理演算子
- 条件を否定するのはNOT演算子。しかし、無理に使う必要はない。
```
NOT演算子の例

SELECT shohin_mei, shohin_bunrui, hanbai_tanka
  FROM Shohin
  WHERE NOT hanbai_tanka >= 1000;
```
- 複数の検索条件を組み合わせる時は、AND演算子とOR演算子を使う。
- OR演算子よりAND演算子の方が優先される。OR演算子を優先したいときは、両辺をカッコ()で囲む。
- NOT,AND,ORは論理演算子。ここでいう論理とは真理値を操作すること。真理値はTRUEかFALSEのいずれかになる値のこと。
  - 比較演算子は演算の結果として真理値を返す。論理演算子は、比較演算子などが返した真理値を操作する。

### NULLを含む真理値
- NULLを含む比較演算の結果としての真理値は、「不明（UNKNOWN）」という第三の値になる。
