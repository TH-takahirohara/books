TCP/IPネットワーク入門

- vagrantの立ち上げ
$ cd ~/ubuntu1804
$ vagrant up
$ vagrant ssh

- vagrantの終了
$ exit  //仮想マシンからのログアウト
$ vagrant halt  //仮想マシンのシャットダウン


## 2.6
traceroute
- パケットが目的地までに通る道順　通過するルータ　経路と呼ばれる
- 通過するルータの台数のことをホップ数という
- インターネットは、たくさんのルータによるパケットのバケツリレー
- 注：IPアドレスを持ってネットワークにつながっている、ルータではないコンピュータをホストという。

## 2.7
- TCP/IPでは、次にパケットを渡すべき相手をルーティングテーブルというもので管理する。ルーティングテーブルは、インターネットにつながるノードがそれぞれ持っている。
ip route show
- ルーティングテーブルは、複数のルーティングエントリから構成される。
- ルーティングエントリを構成する二大要素は、「宛先」と「次にパケットを渡す相手（ネクストホップ）」である。
- 他のどの宛先にも該当しない時に使われる宛先のことをデフォルトルートという。
- ルーティングテーブルを使って、ネクストホップにパケットを転送する作業のことをルーティングという。

# 3 Network Namespace

## 3.1
sudo ip netns add <namespace名>
ip netns list
sudo ip netns exec <namespace名> <コマンド>
sudo ip netns delete <namespace名>

## 3.2
- Network namespaceの作成
- vethという仮想的なネットワークインターフェイスの追加
- vethをnetwork namespaceに所属させる
- vethインターフェイスにIPアドレスを付与する
- vethインターフェイスのstateをdown -> upに変更
- これでpingで疎通確認できる

## 3.3
- 同じネットワークのセグメントに所属するIPアドレス同士は、基本的にルータがいなくても通信できる。
- ルータは、異なるセグメント同士を繋ぐために存在する。

セグメントについて理解するためにIPアドレスを深掘りする
- IPアドレスは、ネットワーク部とホスト部という2つの部分からなる。IPアドレスを、特定のビット数を境目にして前後に分け、前半部分をネットワーク部、後半部分をホスト部と呼ぶ。ネットワーク部に対応する部分をネットワークアドレス、ホスト部に対応する部分をホストアドレスという。
- ネットワークアドレスが同じIPアドレスは、同じセグメントに属する。
- 192.0.2.1/24 のアドレスの後ろの24は、24ビット目までがネットワーク部であることを示している。この書き方はCIDR表記と呼ばれることがある。

## 3.4 ルータの設定
- 一般的にセグメントの先頭または末尾のIPアドレスを使うことが多い。.1 か .254
- セグメントが複数あると、その間を仲介するためにルータが必要になる。この際、ホストは自身が直接つながっていない相手とルータを介して通信するために、ルーティングエントリを必要とする。
- LinuxにおいてIPv4のルータとして動作するかを決めるカーネルのパラメータとして、net.ipv4.ip_forwardがある。これを１に指定するとルータとしての動作が有効になる。

## 3.5 ルータ増やす
- 直接つながっていないセグメントの情報は、ノードに何らかの方法で教えてあげる必要がある。
- 人間が手でルーティングエントリを追加するような方式をスタティックルーティング（静的経路制御）という。ルータ同士が自律的に自身の知っているルーティング情報を教えあう方式は、ダイナミックルーティング（動的経路制御）と呼ぶ。ルーティング情報を交換するのに使うプロトコルはルーティングプロトコルという。

# 4 イーサネット
- OSI参照モデルなどの階層構造を、下から番号を振った呼び方をすることがある。IPならレイヤー3のプロトコル。イーサネットは一般的にレイヤー2のプロトコルとみなされる。
- 現在の家庭やオフィスで用いられるデータリンク層や物理層に対応するプロトコルを含んだ規格はほとんどイーサネットと考えて良い。

## 4.1 イーサネットの役割
- イーサネットでデータを送る単位はフレームという。
- イーサネットでフレームの送信元と送信先を管理するために使われるのが、MACアドレスという識別子である。

## 4.2 フレームを観察する

## 4.3 MACアドレスを知るには
- ARPプロトコルを使うことで、IPアドレスに対応するMACアドレスを解決できる。
- ARPもIPと同じようにイーサネットのフレームで運ばれる。
- ARPリクエストのフレームは、送信先のMACアドレスがブロードキャストアドレス（ff:ff:ff:ff:ff:ff）と呼ばれる特殊なMACアドレスになっている。このフレームは、「このフレームが届く限りの範囲で、すべての機器に聞いてほしい」という意味になる。送信先がブロードキャストアドレスになっているフレームのことをブロードキャストフレームという。また、ブロードキャストフレームが届く範囲のことをブロードキャストドメインという。
- 同じセグメントにARPリクエストを送ったときの挙動は、送信元がブロードキャストドメインに対してブロードキャストフレームを送り、次に、送信先に該当するIPアドレスを持っている機器がARPリプライでMACアドレスを送り返すという形で行われる。
- ARPを使うのはIPv4だけで、IPv6ではICMPv6プロトコルのNeighbor Discoveryという仕組みが用いられる。 

## 4.4 パケットの積み替え
- 一般的に、ブロードキャストドメインの範囲は、ネットワークのセグメントと同じになる。
- ルータを介した別セグメントにpingで通信する場合（ホストns1 -> ホストns2）
  - ns1は、ルーティングテーブルを調べ、ネクストホップとなるIPアドレスを持つノード（この場合ルータ）のMACアドレスを知るために、ARPで解決する。
  - ns1は、解決したMACアドレスに向け、後続のフレームでIPのパケット（ICMPのリクエストを含む）を送る。
  - ルータは、パケットの送信先IPアドレスに一致する宛先をルーティングテーブルから調べる。この場合、送信先IPアドレスのネクストホップがインターフェースになっているので、このインターフェースのブロードキャストドメインの範囲に送信先IPアドレスがいるはずである。なので、ARPでMACアドレスを解決する。
  - 解決できたMACアドレス（ns2）に向け、IPのパケットを送る。
  - ns2からns1へ戻りのパケットを送る。この戻りでは、ARPを使う必要はない。（IPアドレスとMACアドレスの対応関係はARPリクエストを通してわかっているため。）
- パケットがイーサネットのフレームに積み替えられる時、2つのインターフェイスでキャプチャしたイーサネットのフレームは、それぞれ送信元と送信先のMACアドレスは異なる。一方、フレームで運ばれているパケットのIPアドレスは、送信元も送信先も変わっていない。これは、IPパケットという（荷物の入った）ダンボール箱が、イーサネットのフレームというトラックに積み替えられて目的地に運ばれる様子を示している。

## 4.5 ブリッジ
- スイッチングハブ
  - これは、複数のネットワーク機器を同じブロードキャストドメインに参加して通信できるようにする機器。
  - ルータとPCの間に、LANケーブルがたくさんついた箱のような形で設置されている場合がある。
  - USBハブのイーサネット版みたいなもの。
- ブリッジ
  - スイッチングハブという言葉をより一般化した用語が、ブリッジである。
  - データリンク層でフレームを転送する機器のことはブリッジと呼ばれる。（構成としては、ネットワーク層でパケットを転送する機器であるルータに似ている）
  - ブリッジの役割は、自身のどのポートにどのMACアドレスの機器がつながっているのか管理すること。管理するための台帳はMACアドレステーブルという。
- linux ネットワークブリッジがある。ネットワークブリッジもネットワークインターフェースの一種。
- スイッチングハブの重要な特徴として、自身につながっているポートのMACアドレスを学習する機能がある。
  - ARPパケットなどからポートの先にいるMACアドレスを学習する。
  - この機能により、通信相手のいないポートにムダなフレームを流さないようにできる。
  - ムダなフレームを流さないというのは、当たり前のようだが、一昔前まで使われていたリピータハブでは送信元以外のすべてのポートに単にフレームを流すという動作をしていた。
