データベース技術実践入門

# 第3章 テーブル設計とリレーション
- テーブル設計ではまず正規化することが重要。
- 第3正規形までで十分と言われることもあるが、第3正規形でも不具合があることもある。これに対応するにはある程度テーブル設計に慣れて対応できるようになることが必要。

# 第4章 SQL文の特徴とその使いこなし方
- テーブル作成時の注意
  - データベース製品間の互換性確保は難しい
  - 一度作ったテーブルは簡単に変えられない

- 分散データベース環境
  - 大規模なアプリケーションでは、1個のサーバーでは処理を十分にさばくことができないので、テーブル単位で（あるいは1個のテーブルを）複数のサーバーに分散するケースがある。こうした分割のことを「Sharding」と呼ぶ。
  - Shardingをしているとジョインを使うことが難しい。ただ、リモートサーバーにあるテーブルをローカルのデータベース内にあるかのように見せる「データベースリンク」機能を持った製品もある。

# 第5章 可用性とデータの複製
- 障害はデータベースサーバーでも起こりうる。CPUなどの障害に対応するために、サーバーは2台以上に冗長化する必要がある。

## レプリケーション
- 現在最も幅広く用いられている冗長化方式が、複製となるDBを別サーバー上に作成する技術であるレプリケーションである。

### 片方向レプリケーション
#### 片方向／非同期
- マスタに更新した結果がスレーブに非同期で伝播するタイプのレプリケーション
- MySQLでは、マスタで実行した更新形SQLがバイナリログという専用のログファイルに記録されている。スレーブでは、「①バイナリログの受信」と「②バイナリログの実行」という2段階のステップから構成され、それぞれ別々のスレッドが担当する。

#### 片方向／準同期
- 新しいバージョンのMySQLでは「①バイナリログの受信」を同期方式にすることができる。これを準同期レプリケーションという。
- これは、マスタを更新したクライアントは、その結果がマスタのデータベース上で確定するだけでなく対象のスレーブに送信され、その確認応答が帰るまでの間待たされることにな利、その分レスポンスタイムは悪くなる。
- データ消失のリスクと、レスポンスタイムの悪化のバランスをとった現実的な方式と言える。

#### 片方向／同期
- MySQLでは実装されていないが、スレーブに対して更新結果の反映までを終えた状態で初めてクライアントに応答を返すという方式。

### 双方向レプリケーション
- マスタを2個以上持たせて、それぞれのマスタを更新できるようにした「**マルチマスタ（双方向レプリケーション）**」という構成も考えられる。
- 技術的に難しく、分散型排他制御の仕組みが必要になる。

### 障害からの復旧方法
- ほとんどの場合、障害が起きて消失または不整合を起こしたスレーブは、後から新しいものを他のサーバーから作り直して全面復旧させるという方法が取られている。ただ、将来的なデータ容量では時間が相当かかってしまう。
- 将来的には、障害時点と現時点との差分だけを復旧するというアプローチにシフトしていくはず。

### バックアップ
- 人為的ミスへの対処としてはバックアップを取ることが挙げられる。
- バックアップから復旧する場合、最終バックアップ以降に更新された結果はどうなるか、という問題がある。
- その解決方法として、DBでは「**ポイントインタイムリカバリ**（PITR）」という機能を使っている。最終バックアップ以降の更新ログが無事であれば、最終バックアップを復旧した後にそれ以降の更新ログを順次あてていくことで、障害直前の状態まで復旧できる。

### 故意に遅延させたレプリケーション
- 人為的ミスに備えるための技術として「**Time Delayed Replication**」がある。
- マスタで行われた更新を一定時間経過後にスレーブで反映するというものであり、マスタで誤った操作を行った場合、遅延しているスレーブをマスタに昇格させ、問題あるクエリだけ取り除いて別途反映するというものである。

# 第6章 トランザクションと整合性・耐障害性
- DBの更新処理においてエラーが発生した場合に、データが中途半端な状態になる可能性がある。DB的に整合性のとれた状態に自動的に修復することを実現する仕組みを「**トランザクション**」という。更新処理がどこかで失敗した場合は、全部なかったことにしてくれる。
- 例え1個のSQLであっても中では複数の処理が行われているので、データが中途半端な状態になるのを避けるためにトランザクションが重要になる。
- トランザクション機能による恩恵として代表的なものの2つ目は**耐障害の向上**である。OS障害などのサーバ障害が発生し、そこからDBを再起動したときに「障害直前までのコミット 結果を消失せずに済む」ことができる。
  - OracleやInnoDBなどでは技術的には「**REDOログ**」を用いたアーキテクチャで耐障害性を担保している。
- 排他制御のための定番の仕組みが「**ロック**」である。

## レプリケーションとトランザクション
- スレーブは、「マスタから送られてきた更新系クエリの中からどこまでを実行したのか」という情報も管理する必要がある。これらの情報は**アトミック**に（これ以上分割できないように）更新される必要がある。
- MySQL5.6かつInnnoDBの場合に初めてこのアトミックな更新ができるようになった。具体的には、「現在どこまで実行したか」を管理するために、「実行し終えたバイナリログの位置情報」を管理するInnoDBテーブルを用意し、更新SQL文の実行と位置情報の更新を同じトランザクションで行っている。
