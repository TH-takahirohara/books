docker基礎からのコンテナ構築

# 第3章 5分でWebサーバーを起動する
- この章の操作(DockerでApacheを起動する)のまとめ
1. Docker Hubでイメージを探す
2. `docker run`で実行する
  - 指定するオプションなどは、ドキュメントに書かれているので、それを参考にする。
  - `docker run`すれば、それだけでコンテナが起動する。
3. 停止と再開
  - `docker stop <CONTAINER ID or NAME>`で停止、`docker start`で再開。
  - コンテナの状態は`docker ps`で確認できる（起動中のもののみ）停止中のものも含めて確認するときは、`docker ps -a`とする。
4. ログの確認
  - `docker logs`でログの確認が可能
5. 破棄
  - コンテナを停止しても、コンテナは破棄されず、ディスクスペースを消費する。
  - 完全に削除するには、`docker rm`コマンドを使う。
6. イメージの破棄
  - コンテナを破棄しても、その元となったDockerイメージは残ったまま。
  - 保有しているDockerイメージは`docker image ls`コマンドで確認できる。
  - 使わなくなったイメージは、`docker image rm`コマンドを使って削除する。

# 第4章 Dockerの基本操作
- docker run は「docker pull」「docker create」「docker start」の3つのコマンドをまとめて実行する、利便性を重視したコマンド

### イメージ取得
```
docker pull <イメージ名またはイメージID>(:<タグ>)
```
- タグ名を省略したときは、最新版を意味する「latest」が指定されたものとみなされる。

### コンテナの作成
```
docker create オプション イメージ名またはイメージID 実行したいコマンド
```
- 代表的なオプション
  - --name : コンテナの名前をつける
  - -p : ポート番号をマッピングする
  ```
  -p ホストのポート番号:コンテナのポート番号
  ```
  - -v : マウント設定
  ```
  -v ホストのディレクトリ:コンテナのディレクトリ
  ```

### Dockerコンテナの開始と停止
- docker startを実行すると、既定のコマンドか、docker createの引数で明示的に指定したコマンドが実行される。そのコマンドの実行が完了すると、Dockerコンテナは停止する。
- httpdコンテナの既定のコマンドは終了することがないように作られているので、実行しっぱなしの状態でいられる。

## デタッチとアタッチ
- 端末と切り離しで実行する状態をデタッチ（detach）、端末と接続した状態で実行することをアタッチ（attach）という。
- デタッチの状態とアタッチの状態は、実行中に切り替えることができる。

### -dit
- コンテナをバックグラウンドで実行するときは「-d」、キーボード操作するなら「-it」をつける

### docker exec
- 実行中のコンテナ内を操作したいときはdocker execで/bin/bashなどのシェルを起動する。

# 第5章 コンテナ内のファイルと永続化
- コンテナを破棄すると、コンテナ内のデータも失われる。
- コンテナ内のデータを永続化したい場合はマウントする。
- バインドマウントとボリュームマウントがある。
  - バインドマウント： Dockerホストのディレクトリをマウントする方法
  - ボリュームマウント：Docker Engineで管理されている領域にマウントする方法
- バックアップ　（未読）

# 第6章 コンテナのネットワーク
- Dockerホスト同士はIPアドレスで通信できる
  - 既定のbridgeネットワークでは、Dockerホスト同士はIPアドレスで接続できる。IPアドレスは、docker network inspectやdocker container inspectで確認できる。
- コンテナ名で通信したいときはDockerネットワークを作る。
- コンテナ間の通信では-pオプションは関係ない。
- hostネットワークとnoneネットワークというのがあるが、あまり使われない。

# 第7章 複数コンテナをまとめて起動するDocker Compose
- docker-compose.ymlに起動したコンテナ、ネットワーク、ボリュームの情報を記述する。
- `docker-compose up`でまとめて起動。必要なネットワーク、ボリュームも作られる。
  - `-d`オプションをつけるとデタッチド・モードとなり、バックグラウンドでコンテナを実行する。
- `docker-compose down`でまとめて停止・破棄する。ボリュームは残る。
- コンテナの名前はDocker Composeに基づくものになる、

# 第8章 イメージを自作する
- カスタムなイメージを作る方法は2つある。
  - 1. コンテナから作る
    - ベースとなるイメージからコンテナを起動し、その中で操作などを行う。その後、`docker commit`コマンドを使ってイメージ化する。
    - この方法のデメリットは、ベースとなるイメージに対して、どんな変更を加えたか分からないこと。
  - 2. Dockerfileから作る
    - イメージに対する操作を記述したDockerfileを用意し、その記述をもとにイメージを作成する。
    - イメージの作成には`docker build`コマンドを使う。
    - 操作内容がわかるので、1.の問題点を解決する方法と言える。
- いずれの場合も、ベースとなるイメージに対して何か修正する。ベースのイメージには、普通はLinuxの基本的なイメージを使う。
  - よく使うのは、debian, ubuntu, alpine, busybox
- Dockerイメージは、データのサイズを抑えるために「差分しか収録しない」という作り方をする。変更箇所が階層化されていると言え、この階層のことをレイヤーと言う。
- `docker history <イメージ名>` でレイヤーを確認できる。
- Dockerの流儀（ベストプラクティス）に従う。
  1. 1つのコンテナは1つの処理しかしない
  2. 利用するポートを明確にする。（DockerfileのEXPOSE命令）
  3. 永続化すべき場所を明確にする。（DockerfileのVOLUME命令）
  4. 設定は環境変数で渡す。
  5. ログは標準出力に書き出す。
  6. メインのプログラムが終了するとコンテナが終了することを忘れない。（DockerfileのCMD命令やENTRYPOINT命令）

### コンテナのイメージ化
- `docker commit` コマンドを使う。

### Dockerfileからイメージを作る
- この場合、「イメージに含めたいファイル」と「Dockerfile」を1つのディレクトリに置き、それをdocker buildして作るという方法を取る。
- Dockerfileからイメージを作成することを「ビルド」と言う。
- Dockerfileや関連ファイルがあるディレクトリで、docker buildコマンドを実行することでビルドする。
  - myimage01という名前のimageを作る場合のコマンド
    ```
    docker build -t myimage01 .
    ```

### Dockerfileの命令
- ファイルコピー　COPY, ADD
- コマンドの実行
  - RUN : イメージの作成時に実行
    - 注意点は、複数のコマンドを実行するときも、できるだけ1つのRUNコマンドで済ませるように書くという点。
  - CMDとENTRYPOINT : コンテナの実行時に実行
    - CMDやENTRYPOINTは、それぞれDockerfileに1つしか記述できない。
- ポート番号は、EXPOSEで指定する。-pオプションだけを指定し、ポート番号を省略したときに、ここで指定したポートのマッピングが行われる。-pオプションを指定しなければマッピングされない。
- イメージが永続化されることを期待する場所は、VOLUME命令で記述する。使い方はEXPOSEと同様。
- EXPOSEやVOLUMEは、利用しているポートや永続化を期待しているディレクトリを、イメージの利用者に伝えるという意味合いのもの。

### Dockerfileとキャッシュ
- Dockerfileを使うときはキャッシュの問題があることに注意する。

### イメージの保存と読み込み
- docker saveでイメージからファイル化する。
- tar形式のファイルからイメージに戻すには、docker loadを使う。

### Docker Hubへの登録
- docker loginしてからdocker pushを実行することで登録できる。

### プライベートなレジストリ
- 完全にプライベートにイメージを管理したい場合、プライベートなレジストリを使う。例えば、Amazon ECR。
