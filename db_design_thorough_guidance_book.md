達人に学ぶDB設計徹底指南書

# 第1章 データベースを制する者はシステムを制す
## 1-1 システムとデータベース
- データベースを使わないシステムは、この世に存在しない。
- 本書でのデータの定義は、「ある形式（フォーマット）に揃えられた事実」である。形式は二次元表など。データベースは、こうした一定の形式に従ったデータの蓄積である。
- 一方、情報という概念は、データと文脈を合成して生まれるものである。
- システムは、ユーザーが登録したデータを引き出して情報を作り出すという一連のサイクルの中に位置付けることもできる。

## 1-2 データベースあれこれ
- 現在商用利用されているデータベースには何種類かあるが、その分類はデータを保持するフォーマットを基準にして行われている。
  - リレーショナルデータベース：　最も広く利用されている。
  - オブジェクト指向データベース
  - XMLデータベース
  - キー・バリュー型ストア（Key-Value Store: KVS）
  - 階層型データベース
- モデルが異なれば設計技法も異なる。ただし、設計技法の達成したい目的（データの整合性の保持や冗長性排除など）はモデルが変わっても同じである。
- RDBでもDBMSは複数あるが、DBMSが異なっても、（基本的には）設計の方法は影響を受けない。

## 1-3 システム開発の工程と設計
- 開発の工程は以下に分解・分類できる。
  1. 要件定義：　要件（システムが満たすべき機能など）を決める工程
  2. 設計：　要件を満たすために必要なシステムを作るための設計を行う工程
  3. 開発（実装）：　設計書に従ってシステムを実際に作る工程
  4. テスト：　実装によって組み上がったシステムが、実用に耐える品質であるかを試験する工程
- 本書では設計工程に焦点を当てていく。
- システム開発の進め方（開発モデル）には大きく分けて二つの方法がある。
  - ウォーターフォールモデル
  - プロトタイピングモデル

## 1-4 設計工程とデータベース
- 本書では、データベースに保持するデータの設計（データベース設計と呼ぶ）について述べる。これが重要な理由は二つ。
  1. システムにおいて大半のデータ（少なくとも永続的に使用されるデータ）はデータベース内に保持される。そのため、普通、データ設計とはデータベース設計とほぼ同義である。
  2. データ設計がシステムの品質を最も大きく左右する。ソフトウェアというのは、言ってみれば「データの流通機構」であって、どのようなプログラムが必要になるかは、どのようなデータをどういうフォーマットで設計するかに左右される。

### DOAとPOA
- このうち特に重要なのが理由1である。近年のソフトウェア開発では、データ中心アプローチ（Data Oriented Approach:DOA）という考え方が主流となっているためである。かつて主流の考えであったプロセス中心アプローチ（POA）は現在では普通採用されることはない。
- POAはプロセス単位でデータ設計を行うことになるため、複数のプロセスで同じデータを別個に持つという冗長性が生じるなどの不都合が多い。
- DOAはPOAの欠点を克服するために登場した。その着眼のポイントは、データがあまり変化しない（永続的）という点である。データの意味や形式が先に決まっていれば、複数のプログラムで共用することも容易で、業務要件の仕様変更にも柔軟に対応できる。
- こうした理由から、システム開発においては、プログラム設計に先立ってまずデータ設計が優先されるのである。
- よって、データ設計（≒データベース設計）はシステムの品質を決める最も重要な要因と言っても過言ではない。

### 3層スキーマ
- DB設計で踏むべき具体的な段階について整理する上で重要となる概念が「スキーマ」である。DB設計においては、データベースのデータ構造やフォーマットという意味で使う。DB設計のステップは、このスキーマのレベルと密接に結びついている。スキーマは、一般的に三つのレベルに分けられる。
  1. 外部スキーマ
  2. 概念スキーマ
  3. 内部スキーマ
- この三つのスキーマに基づいてシステムを記述したモデルを、「3層スキーマモデル」と呼ぶ。

1. 外部スキーマ
  - ユーザーから見たデータベースの姿を定義するスキーマ。DBのオブジェクトとしては、ビューが相当する。
2. 概念スキーマ
  - 開発者から見たデータベースの姿を定義するスキーマ。
  - 必然的に、DB設計において重要な位置を占めることになる。
  - 概念スキーマの設計を「論理設計」とも呼ぶ。
3. 内部スキーマ
  - DBMSから見たデータベースを定義するスキーマ。
  - 論理設計との対比で「物理設計」と呼ぶ。

- 概念スキーマがいらないように見えるが、これは外部スキーマと内部スキーマの間にあることで、両者の変更が互いに影響しあわないようにするための緩衝材の役割を果たす。このようなスキーマの独立性のことを、**データ独立性**と呼ぶ。外部スキーマからの独立性を**論理的データ独立性**、内部スキーマからの独立性を**物理的データ独立性**と呼ぶ。概念スキーマはデータ独立性を保証するためにある。
- 概念の有用性がわからなかったら、「それがなかったらどうなるか」を考えてみるのが良い。

演習1-1

演習1-2
問題1：
- 問題となるSQLの特定、当該SQLのチューニング
問題2：
- 顧客との要件の再調整、必要な情報の出力処理を実装、UIの修正

# 第2章 論理設計と物理設計
## 2-1 概念スキーマと論理設計
- 概念スキーマを定義する設計を、論理設計と呼ぶ。
- システムの世界での論理とは、「物理層の制約（実装レベルの条件）にとらわれない」という意味。
- 原則として、論理設計は物理設計に先立つ。
- 論理設計は、現実世界に存在する数多くのデータから、リレーショナルデータベースにおいて、何を、どのようなフォーマットで保存するかを決めること。具体的には下記のタスクが含まれる。
  1. エンティティの抽出
  2. エンティティの定義
  3. 正規化
  4. ER図の作成

### エンティティの抽出
- エンティティは「実体」と訳すが、物理的実体が伴う必要はない。（税、注文履歴などでも良い）
- システムにどのようなエンティティ（=データ）が必要かを抽出することは一部が要件定義と重なるため、この工程はある程度顧客やシステム利用者と要件を詰めていく中で実施することになる。

### エンティティの定義
- エンティティは、データを「属性」（二次元表の列と同義）という形で保持する。エンティティの定義は属性を決めること。
- ここで特に重要なのは「キー」という列を定義すること。キーとは、ある特定の列の値を決定するための列(複数列でも良い)のこと。

### 正規化
- 正規化は、エンティティ（テーブル）について、システムでの利用がスムーズに行えるよう整理する作業
- RDBの論理設計においては、この正規化が最も重要な土台をなす。

### ER図の作成
- 正規化を行うとエンティティの数が増えてエンティティ同士の関係が把握しづらくなるので、関係を表現する図を作成することで理解しやすくする必要がある。

## 内部スキーマと物理設計
- 物理設計の流れは大きく分類すると以下の5つがある。
  1. テーブル定義
  2. インデックス定義
  3. ハードウェアのサイジング
  4. ストレージの冗長構成決定
  5. ファイルの物理配置決定

### インデックス定義
- インデックスは機能ではなくパフォーマンスに重要な役割を果たす。

### ハードウェアのサイジング
- サイジングはキャパシティ（データサイズに対する記憶装置の選定）とパフォーマンス（サーバーのCPUやメモリ）の2つの観点から行う。
- データベースの性能問題の８割はディスクI／Oによって起きる。
- DBにおいては、データの整合性とパフォーマンスの間に強いトレードオフがある。

#### パフォーマンスのサイジング
- システム開発での性能要件は二つの指標を使って定義する。
  - 処理時間　どれだけ早く処理できるか
  - スループット　どれだけたくさん処理できるか。1秒当たり仕事量TPSを指標に使う。

- 精度の高いサイジングは難しい。そのため、必ず実施時には安全率をかけ、スケーラビリティの高い構成を組む。

### ストレージの冗長構成
- ストレージが高い耐障害性を持つようにするための技術としてRAIDがある。
- RAIDの基本的な考えは、複数のディスクに同じデータを書き込んで冗長化し、一本が壊れても残りのディスクでデータを保全できるというもの。（信頼性向上）
- それだけでなく、RAIDは複数のディスクにデータを分散して保持することで、性能的にボトルネックとなるディスクI/Oを分散し、パフォーマンス向上を図ることができる。（性能向上）
- DBの物理設計では、RAIDについて以下を考える必要がある。
  - 当該データには、信頼性が求められるのか、それとも性能が求められるのか（最も重要な問い）
  - どのようなレベルのRAIDを採用するか
  - 何本のディスクでRAIDを構成するか
- RAIDの主な種類
  - RAID0
  - RAID1
  - RAID5
  - RAID10
- DBサーバーのストレージにおけるRAIDとして、少なくともRAID5で構成する。お金に余裕があればRAID10。RAID0は論外。

### ファイルの物理配置
- DBのファイルをどのディスク（またはRAIDグループ）に配置するかを検討する工程。
- DBに格納されるファイルは用途別に5種類に大別できる。開発者がその存在を意識するのはデータファイルとインデックスファイルのみ。
  - データファイル、インデックスファイル、システムファイル、一時ファイル、ログファイル
- 5種類のファイルの物理配置を考える際、最も重要なことはサイズと性能である。性能について考慮すると、5種類をそれぞれ別のディスクに分けるということになるが、それだけ潤沢にディスクを用意できることは滅多にないため、I/O量が比較的低いログファイルとシステムファイルを同じディスクにまとめるなどコストを下げていく。

## 2-3 バックアップ設計
- データベースの物理設計と隣接する領域に、データのバックアップおよびリストアの設計がある。
- この設計には二通りの方針がある。
  - 一つは、極力データを失わないような設計にすること。（例：RAID設計）
  - 二つ目は、障害によってデータが失われたときに、復旧できるようにしておくこと。これが本章で解説するバックアップとリカバリである。

### バックアップの基本分類
- バックアップは基本的にファイルのコピーで行う。
- 主要な三つのバックアップ方式は以下の通り。
  - フルバックアップ（完全バックアップ）
  - 差分バックアップ
  - 増分バックアップ

#### フルバックアップ
- ある時点でそのシステムで保持されているすべてのデータをバックアップする方式
- 下記の欠点がある。
  - 1. バックアップの時間が（他の方式に比べて）長い
  - 2. ハードウェアリソースへの負荷が（他の方式に比べて）高い
  - 3. サービス停止が必要　バックアップ中にデータが変更されるとデータ整合性が取れないため

#### 差分バックアップ
- ある時点で取得したフルバックアップに対する変更分だけのバックアップを適宜取得する方法。
- 差分管理はログファイル（トランザクションログ）をバックアップすることで実現する。トランザクションログにはDB内のデータに対する変更操作の履歴が残っているため、これをバックアップしておけばDBに対する変更操作を再現することが可能。
- 運用イメージとしては、例えば、月曜だけフルバックアップをとり、火曜〜土曜は月曜からの変更分のみをバックアップする。日曜に障害が起きたときは、月曜に取得したフルバックアップ＋土曜に取得した差分バックアップが必要。
- 利点：バックアップデータ量が減ること
- 欠点：リカバリの手順が増えて時間も長くなること
