マスタリングTCP/IP 入門編 第5版

### 1.8.2 アドレスの階層性
- MACアドレスとIPアドレス　両方唯一性はあるが、階層性はIPアドレスのみ
- MACアドレス：　転送表（フォワーディングテーブル）
- IPアドレス：　経路制御表（ルーティングテーブル）

## 1.9 ネットワークの構成要素
- ネットワークインタフェース：　コンピュータをネットワークに接続するための装置
- リピーター：　ネットワークを物理層で延長する装置
- ブリッジ／レイヤ2スイッチ：　ネットワークをデータリンク層で延長する装置
- ルーター／レイヤ3スイッチ：　ネットワーク層によってパケットを転送する装置
- レイヤ4-7スイッチ：　トランスポート層より上の情報でトラフィックを処理する装置
- ゲートウェイ：　プロトコルの変換をする装置

### 1.9.1 通信媒体とデータリンク

### 1.9.2 ネットワークインタフェース

### 1.9.3 リピーター
- ネットワークを物理層で延長する装置
- 減衰して変形した信号の波形を増幅・整形して流す

### 1.9.4 ブリッジ／レイヤ2スイッチ
- データリンク層でネットワーク同士を接続する装置。MACアドレスで処理を行う。
- ブリッジは、データリンクのフレームのFCSと呼ばれるフィールドをチェックして、壊れたフレームを他のセグメントへ送信しないようにする働きがある。
- ラーニングブリッジ
- イーサネットなどで利用されるスイッチングハブは、現在ではほとんどがこのブリッジの一種

### 1.9.5 ルーター／レイヤ3スイッチ
- ネットワークとネットワークを接続して、パケットを中継する装置。ネットワーク層のアドレス（TCP/IPではIPアドレス）で処理を行う。

### 1.9.6 レイヤ4-7スイッチ
- トランスポート層からアプリケー ション層の情報に基づいて配送処理を行う
- ロードバランサーは、複数のサーバーに負荷を分散するレイヤ4-7スイッチの一種

### 1.9.7 ゲートウェイ
- トランスポート層以上の情報を見てパケットを処理するが、それだけでなくデータを変換する役割がある。特に、異なるプロトコルの変換を行うためによく利用される。
- ウェブにおいて、トラフィックの軽減やセキュリティを意図して代理サーバー（プロキシサーバー）を設定する場合がある。この代理サーバーもゲートウェイの一種である。

## 1.10 現在のネットワークの姿
### 1.10.1 実際のネットワークの構成
- コア（バックボーン）
- エッジ
- アクセス（アグリゲーション）

### 1.10.2 インターネット接続サービスを利用した通信

### 1.10.3 携帯電話による通信
- 基地局が「アクセス」に相当する。

### 1.10.4 情報発信者側にとってのネットワーク
- データセンター

#### 仮想化とクラウド
- 仮想化技術：　サーバーなどを、ソフトウェアを使って論理的に、必要な時に必要な量を提供できるようにする仕組み
- 仮想化技術を利用し、利用者にとって必要な資源を自動的に提供する仕組みをクラウドと呼ぶ。
- また、仮想化されたシステム全体を必要に応じて自動的に制御する仕組みをオーケストレーションと呼ぶ。

# 第2章 TCP/IP 基礎知識
## 2.1 TCP/IP登場の背景とその歴史
### 2.1.1 軍事技術の応用から
- 軍事的な理由から、障害に強い分散型のネットワークと、それを実現するためのパケット通信の必要性が唱えられた。
- また、パケット通信を利用すれば、複数ユーザーで1つの回線を共有できるというコスト面のメリットも注目された。

### 2.1.2 ARPANETの誕生
- 1969年、パケット交換技術の実用性試験のためにARPANETと呼ばれるネットワークが構築された。この実験により、パケットによるデータ通信手法が実用に耐えることが証明された。

### 2.1.3 TCP/IPの誕生
- 1970年代前半に、ARPANET内の研究グループによって、TCP/IPが開発された。

### 2.1.4 UNIXの普及とインターネットの拡大
- 1980年前後の大学や研究所などでは、コンピュータのOSとしてBSD UNIXが広く利用されていた。このOSの内部にTCP/IPが実装されていた。
- 1980年代に、LANの発達とUNIXワークステーションの普及が急速に進むと同時に、TCP/IPによるネットワークの構築も盛んに行われるようになった。
- インターネットは、終端ノード間のUNIXマシン同士をつなげる形で普及していった。

### 2.1.5 商用インターネットサービスの開始
- 90年代になると、企業や一般家庭に対してインターネットへの接続を提供するサービスが普及し、広く利用されるようになった。このようなサービスを提供する会社をISPと呼ぶ。
- TCP/IPは、研究ネットワークとしてインターネットで長い間運用されてきたことで、商用サービスにも耐えうる成熟したプロトコルになっていた。

## 2.2 TCP/IPの標準化
- TCP/IP の標準化には、ほかのプロトコルの標準化には見られない特徴がある。

### 2.2.1 TCP/IPという語は何を指す
- 多くの場合、TCP/IPという言葉は、IPを利用したり、IPで通信したりするときに必要となる多くのプロトコル群の総称として使われる。

### 2.2.2 TCP/IP標準化の精神
- TCP/IPのプロトコルの標準化は、ほかの標準化と比べると2つの点が大きく異なる。
  1. オープンであること
  2. 標準化するプロトコルが実際に使えるプロトコルであるかどうかを重視すること（動かすことを重視して仕様が決められるのでプロトコルの実用性が高い）
- TCP/IPに比べてOSIが一般に普及しなかったのは、上記の特徴がなかったことが原因と考えられている。

### 2.2.3 TCP/IPの仕様書 RFC
- IETFで議論され、標準化しようとするプロトコルは、RFCと呼ばれるドキュメントになり、インターネット上で公開される。RFCは仕様書だけでなく、プロトコルの実装や運用に関する有用な情報やプロトコルの実験に関する情報も含まれる。
- STD

### 2.2.4 TCP/IPプロトコルの標準化の流れ
- 標準化の流れは、大まかに次の段階を経る事になる。
  - インターネットドラフト、提案標準、ドラフト標準、標準
- TCP/IPの世界では、「標準」になったプロトコルにはすでに広い運用実績があるため、非常に実用性が高い技術となる。

### 2.2.5 RFCの入手方法

## 2.3 インターネットの基礎知識
### 2.3.1 インターネットとは
- 現在、インターネットというと、ARPANETから発展し、全世界を接続しているコンピュータネットワークのことを指す。

### 2.3.2 インターネットとTCP/IPの関係
- インターネットのプロトコルといえばTCP/IP。逆も然り。

### 2.3.3 インターネットの構造
- NOC: ネットワークとネットワークを接続するポイント
- IX: ネットワークの運用者（ISP等）などが異なるネットワークを対等に接続するポイント
- インターネットは、異なる組織がIXによって相互に接続された巨大なネットワークと言える。

### 2.3.4 ISPと地域ネット
- インターネットに接続するためには、ISPや地域ネットに接続を依頼することになる。

## 2.4 TCP/IPプロトコルの階層モデル
- TCP/IPプロトコルの全体像の説明

### 2.4.1 TCP/IPとOSI参照モデル
- OSI参照モデル：　「通信プロトコルに必要な機能は何か」を中心に考えてモデル化
- TCP/IPの階層モデル：　「プロトコルをコンピュータに実装するにはどのようにプログラミングしたら良いか」を中心に考えてモデル化

### 2.4.2 ハードウェア（物理層）
- イーサネットや電話回線などの物理層のこと。しかしその内容については何も決めていない（なんでも良い）

### 2.4.3 ネットワークインタフェース層（データリンク層）
- イーサネットなどのデータリンクを利用して通信をするためのインタフェースとなる階層。つまりNICを動かすための「デバイスドライバ」と考えて良い。
- NICを購入した場合、ソフトウェアとしてデバイスドライバが普通は付属される。それを利用するコンピュータのOSにインストールすることで、初めてネットワークインタフェースを利用できる環境が整う。

### 2.4.4 インターネット層（ネットワーク層）
- IPプロトコルが使われる。
- IP
- ICMP
- ARP

### 2.4.5 トランスポート層
- トランスポート層の最も重要な役割はアプリケーションプログラム間の通信を実現すること。
- TCP：　コネクション型で信頼性のあるトランスポート層のプロトコル
- UDP：　コネクションレス型で信頼性のないトランスポート層のプロトコル

### 2.4.6 アプリケーション層（セッション層以上の上位層）
- WWW(World Wide Web)
  - Webブラウザというソフトウェアを使う。ブラウザとサーバー間の通信で使われるプロトコルがHTTP。送信に使われる主なデータフォーマットがHTML。
  - WWWでは、HTTPがOSI参照モデルのアプリケーション層のプロトコル、HTMLがプレゼンテーション層のプロトコルと言える。
- 電子メール
  - SMTP
  - 電子メールで送信できるデータ形式を拡張するMIME(OSI参照モデルのプレゼンテーション層の機能)
- ファイル転送（FTP）
- 遠隔ログイン（TELNETとSSH）
- ネットワーク管理（SNMP）

## 2.5 TCP/IPの階層モデルと通信例
- TCP/IPを使うときの、アプリケーション層から物理媒体までのデータと処理の流れを見てみる。

### 2.5.1 パケットヘッダ
- パケット、フレーム、データグラム、セグメント、メッセージ
- パケットヘッダには、プロトコルの仕様が見える形で存在していると言える。

### 2.5.2 パケットの送信処理 - メール送信の例
1. アプリケーションの処理
  - 符号化, 送信タイミングの管理, 送信時にTCPにコネクション確立を指示, 確立されたらそれを利用してメールデータを送信
2. TCPモジュールの処理
  - アプリケーションの指示により、コネクションを確立したり、データを送信したりする。
3. IPモジュールの処理
  - TCPから渡されたデータにIPヘッダを付与しIPパケットを構成
  - ルーティングテーブルをもとに、次に渡すノードが接続されるネットワークインタフェースのドライバにIPパケットを渡す
  - 通信先のノードのMACアドレスが分からない場合は、ARPを利用してMACアドレスを解決
4. ネットワークインタフェース（イーサネットドライバ）の処理
  - IPから渡されたIPパケットに、イーサネットのヘッダを付与し送信処理を実行

### 2.5.3 データリンクを流れるパケットの様子
- パケットが流れる時は、先頭にイーサネットヘッダがつき、その後ろにIPヘッダが、というように続く。
- それぞれのヘッダには、少なくとも2種類の情報が入っている。それは「宛先と送信元のアドレス」と「上位層のプロトコルが何かを示す情報」である。

### 2.5.4 パケットの受信処理
- 受け取ったホストでの処理は、送信ホストの処理と全く逆になる。
5. ネットワークインタフェースの処理
6. IPモジュールの処理
7. TCPモジュールの処理
  - チェックサムを計算してヘッダやデータが壊れていないかを確認する。データを順番通りに受信しているか確認。
8. アプリケーションの処理

# 第3章 データリンク
## 3.1 データリンクの役割
- データリンクという言葉は、OSI参照モデルのデータリンク層を指す用語として使われる場合と、具体的な通信手段（イーサネットなど）を指す一般的な用語として使われる場合がある。
- データリンク層のプロトコルは、通信媒体で直接接続された機器間で通信するための仕様を定めている。
- 実際に機器の間で通信を行う場合には、データリンク層と物理層が共に必要になる。
  - 物理層は、実際の通信媒体でやり取りされる物理的な変量を、2進数の0と1に変換する働きを担う。
  - データリンク層では、単なる0と1の列ではなく、「フレーム」という意味のあるかたまりにまとめて相手の機器に伝える。

## 3.2 データリンクの技術
### 3.2.1 MACアドレス
- MACアドレスは、データリンクに接続しているノードを識別するために利用される。

### 3.2.2 媒体共有型のネットワーク
- 媒体共有型のネットワークとは、通信媒体を複数のノードで共有するネットワーク。初期のイーサネットや FDDI は媒体共有型のネットワーク。
- 半二重通信となり、通信の優先権を制御する仕組みが必要になる。その仕組みとしては、コンテンション方式やトークンパッシング方式がある。
- コンテンション方式
  - データの送信権を競争で奪い取る方式。CSMA方式とも呼ばれる。
  - CSMA/CD
- トークンパッシング方式
  - トークンパッシング方式では、トークンと呼ばれるパケットを巡回させ、このトークンで送信権を制御する。

### 3.2.3 媒体非共有型のネットワーク
- 通信媒体を共有せずに専有する方式。ステーションはスイッチと呼ばれる装置に直接接続され、そのスイッチがフレームを転送する。全二重通信。
- 最近のイーサネットでも主流となっている。
- コンピュータとスイッチのポートが1対1接続で全二重通信の場合には、衝突が発生しなくなるため、CSMA/CDの機構は不要になり、より効率の良い通信ができるようになる。

#### 半二重通信と全二重通信
- 半二重通信とは、送信している間は受信できず、受信している間は送信できないような通信のこと。
- 全二重通信は、送信と受信を同時に行える通信。　送受信でそれぞれ専用のメディア（線）がある

### 3.2.4 MACアドレスによる転送
- イーサネットスイッチ
- 転送表（フォワーディングテーブル）
- スイッチでの自己学習

### 3.2.5 ループを検出するための技術
- ブリッジでループのあるネットワークを作ると、最悪の場合フレームが永久に回り続ける。解決方法としてスパニングツリーとソースルーティングという2つの方式がある。
- スパニングツリー
  - スパニングツリープロトコルでネットワークの構造を調べ、特定のポートを使わないようにしてループを解消する。
  - ブリッジの機能だけでループを解消できる。
- ソースルーティング
  - 送信コンピュータ自体がソースルーティング機能を持っている必要がある。

### 3.2.6 VLAN(Virtual LAN)
- VLANを導入することで、配線の変更を行うことなく、ネットワークセグメントを変更できる。しかし、物理的なネットワーク構成と、論理的な構成が異なることになるため、分かりにくく管理しにくいネットワークになる可能性がある。

## 3.3 イーサネット

### 3.3.1 イーサネットの接続形態
- 現在では、端末とスイッチの間を占有のケーブルで接続してイーサネットプロトコルで通信する形態が一般的になっている。

### 3.3.2 イーサネットにはいろいろな種類がある

### 3.3.3 イーサネットの歴史
- 当初のイーサネットではアクセス制御方式としてCSMA/CDが採用されており、高速化は難しいとされていた。
- しかし、スイッチ技術の進歩と、カテゴリ5のUTPの普及により、状況は変わった。媒体非共有でスイッチと接続されるようになったイーサネットには衝突検知が必要なくなり、高速化への障壁も無くなった。
- 現在では、イーサネットは、他の有線LAN技術を必要としないレベルで発展したと言える。

### 3.3.4 イーサネットのフレームフォーマット
- プリアンブル： フレームの先頭に付与され、イーサネットフレームの開始を表す。8オクテット（1オクテット=8bit）
- フレーム本体の先頭に来るイーサネットのヘッダは合計14オクテットある。
  - 宛先MACアドレスのフィールドが6オクテット
  - 送信元MACアドレスのフィールドが6オクテット
  - データ部分で運んでいる上位層のプロトコルの種類を表すフィールドが2オクテット
- FCS： フレームが壊れていないかどうかをチェックするためのフィールド。フレーム末尾に含まれる。4オクテット

## 3.4 無線通信
### 3.4.1 無線通信の種類
- 無線通信は、その通信距離の応じて分類される。

### 3.4.2 IEEE802.11
- IEEE802.11は、無線LANプロトコルの物理層とデータリンク層の一部（MAC層）を定義した規格。
- MAC層のアクセス制御方式としてCSMA/CAが採用されている。

### 3.4.3 IEEE802.11b, IEEE802.11g

### 3.4.4 IEEE802.11a

### 3.4.5 IEEE802.11n
- MIMO

#### Wi-Fi
- Wi-Fiは、無線 LAN の業界団体である WECA(Wireless Ethernet Compatibility Alliance)によって、IEEE 802.11 規格群の普及を目的として付けられたブランド名

### 3.4.6 無線LANを使用する場合の留意点
- 電波の性質を利用しているので、電波の受信範囲で盗聴や改竄の危険に常にさらされていると言える。
- 強力な暗号化が備わった規格（IEEE802.11i）を使ったり、アクセス制御を併用することで、できる限り安全な環境で利用する必要がある。
- 電波干渉の影響

### 3.4.7 Bluetooth
- 2.4GHz帯
- 電源容量の小さな危機を対象としている。

### 3.4.8 WiMAX
- WiMAX(Worldwide Interoperability for Microwave Access)は、マイクロ波を使って、企業や自宅への無線接続を行う方式

### 3.4.9 ZigBee
- 家電などに組み込むことを前提に、低消費電力で短距離の無線通信を実現する規格

## 3.5 PPP (Point-to-Point Protocol)
### 3.5.1 PPPとは
- ポイントツーポイント（1対1）でコンピュータを接続するためのプロトコル
- PPPoE(PPP over Ethernet)

### 3.5.2 LCPとNCP

### 3.5.3 PPPのフレームフォーマット

### 3.5.4 PPPoE

## 3.6 その他のデータリンク

## 3.7 公衆アクセス網
### 3.7.7 VPN
- IP-VPN
  - ラベル付けと暗号化により通信事業者のネットワーク内に仮想的な独自ネットワークを作り上げる
  - 企業などが独自にインターネット上にVPNを構築する場合もある。IPsecを使うのが一般的。
- 広域イーサネット
  - IP-VPNがIP層での接続サービスであるのに対して、広域イーサネットはデータリンク層であるイーサネットを用いたVLANを利用する。TCP/IP以外のプロトコルも利用できる。

# 第4章 IPプロトコル
## 4.1 IPはインターネット層のプロトコル
### 4.1.1 IPはOSI参照モデルの第3層に相当
- ネットワーク層の役割を一言で言うと、「終点ノード間の通信を実現する」こと。

### 4.1.2 ネットワーク層とデータリンク層の関係
- データリンク層の役割：　切符（区間内での移動を制御）
- ネットワーク層：　行程表

## 4.2 IPの基礎知識
- IPには大きく3つの役割がある。IPアドレス、終点ホストまでのパケット配送（ルーティング）、IPパケットの分割処理と再構築処理。

### 4.2.1 IPアドレスはネットワーク層のアドレス
- ブリッジやスイッチングハブにはIPアドレスを設定する必要はない。

### 4.2.2 経路制御（ルーティング）
- 経路制御(ルーティング)は、宛先 IP アドレスのホストまでパケットを届けるための機能
- 最終的な宛先ホストまでのパケット配送
  - ホップバイホップルーティング
- 経路制御表（ルーティングテーブル）

### 4.2.3 データリンクの抽象化
- データリンクごとに最大転送単位（MTU）が異なる。異なるMTUのデータリンク間でも問題なくパケットを送付できるように、IPでは分割処理（フラグメンテーション）を行う。
- 分割されたパケットは宛先ホストでIPにより再び1つにまとめられ、IPより上位層には元の長さのパケットが渡される。このようにIPには、IPの上位層からはネットワークの細かい構造を見えにくくする役割がある。

### 4.2.4 IPはコネクションレス型
- IPがコネクションレス型である理由は、機能の簡略化と高速化のため。

## 4.3 IPアドレスの基礎知識
### 4.3.1 IPアドレスとは
- IPアドレスは、NICごとに割り当てる。ホストには最低１つ、ルーターには2つ以上のIPアドレスが付けられる。1つのNICに2つ以上のIPアドレスをつけることもできる。

### 4.3.2 IPアドレスはネットワーク部とホスト部から構成される
- ネットワーク部：データリンクのセグメントごとに値を割り当てる。
- ホスト部：同一セグメント内で重ならない値を割り当てる。

### 4.3.3 IPアドレスのクラス
- IPアドレスは、クラスA~Dという4つのクラスに分類されていた。
  - クラスA：　先頭1ビットが0で始まる。下位24ビットがホストアドレス
  - クラスB：　先頭2ビットが10で始まる。下位16ビットがホストアドレス
  - クラスC：　先頭3ビットが110で始まる。下位8ビットがホストアドレス
  - クラスD：　先頭3ビットが1110で始まる。先頭から32ビットまでがネットワーク部。IPマルチキャスト通信に使われる。
- IPアドレスのホスト部を割り当てる場合に注意すべきことは、ホスト部のビットをすべて０あるいはすべて１にすることができないと言うこと。

### 4.3.4 ブロードキャストアドレス
- ブロードキャストアドレスは、同一リンクに接続されたすべてのホストにパケットを送信するためのアドレス。IPアドレスのホスト部のビットをすべて1にすると、ブロードキャストアドレスになる。
- ブロードキャストには、ローカルブロードキャストとダイレクトブロードキャストの 2 つがある。
  - ローカルブロードキャスト：　自分が属するリンク内のブロードキャスト（例：自分が属するネットワークが192.168.0.0/24の場合、192.168.0.255へ送る）
  - ダイレクトブロードキャスト：　異なるIPネットワークへのブロードキャスト（例：自分が属するネットワークが192.168.0.0/24の場合、192.168.1.255へ送る。こうすると、192.168.1.0/24のすべてのホストにパケットを送れる）

### 4.3.5 IPマルチキャスト
- マルチキャストは、特定のグループに所属するすべてのホストにパケットを送信するために利用される。
- マルチキャスト機能は、ルーターを超えることができ、また、必要としているグループのみにパケットを送信できる。（ブロードキャストでは関係のないホストへも影響を与えるため、ネットワーク全体のトラフィックが大きくなると言う問題があった。）
- IPマルチキャストでは、クラスDのIPアドレスを使用する。先頭４ビット以外の２８ビットがマルチキャストの対象となるグループ番号になる。
- IGMP

### 4.3.6 サブネットマスク
- クラスAやBをそのまま使うのは無駄が多い（ホストアドレスが多すぎる）ので、クラスをそのまま使うことは許されなくなり、無駄を小さくする仕組みが導入された。それが、クラスAやBのネットワークを小さく区切るサブネットワークアドレス。これは、クラスごとに決まるホスト部をサブネットワークアドレス部として使うことにより、複数の物理ネットワークに分割できるようにする仕組み。
- サブネットワーク、サブネットマスク
  - サブネットマスク：　ネットワーク部を表す識別子

### 4.3.7 CIDRとVLSM
- IPアドレスのクラス分けを廃止し、任意のビット長でIPアドレスを配布するようになった。これをCIDRと呼ぶ。
- CIDRを適応することによって、連続する複数のクラスCアドレスを、1つの大きなネットワークとして扱うことが可能になる。
- 組織内の部署ごとにサブネットマスク長が変えられるようにする仕組みが可変長サブネットマスクVLSM。

### 4.3.8 グローバルアドレスとプライベートアドレス
- 私的なネットワークで利用できるプライベートIPアドレスは次の範囲
  - 10.0.0.0 ~ 10.255.255.255 (10/8)
  - 172.16.0.0 ~ 172.31.255.255 (172.16/12)
  - 192.168.0.0 ~ 192.168.255.255 (192.168/16)
- NAT

### 4.3.9 グローバルIPアドレスは誰が決める
- グローバル IP アドレスは全世界的に ICANNで一元管理されている。日本ではJPNICが割り当て機関。
- 現在では、ISPにインターネットへの接続を依頼するとき、同時にグローバルIPアドレスの申請も依頼することがほとんどである。（ISPがJPNICにアドレス割り当てを申請する。）
- ADSLなどのインターネット接続サービスの場合、プロバイダから自動的にIPアドレスが割り当てられるので、一般ユーザーがIPアドレスを申請する必要はない。

## 4.4 経路制御（ルーティング）
- ホストやルーターは、経路制御表をもとにしてパケットの送信先を決定し、パケットを配送する。
- 経路制御表の作成方法には、スタティックルーティング（静的経路制御）とダイナミックルーティング（動的経路制御）がある。前者は管理者が事前に設定する方法で、後者はルーター同士が情報を交換して自動的に作成する方法。
- ダイナミックルーティングの場合、ルーティングプロトコルを適切に設定する必要がある。ルーティングプロトコルはIPプロトコル自体とは別のものである。

### 4.4.1 IPアドレスと経路制御（ルーティング）
- 経路制御表には、ネットワークアドレスと、次に配送すべきルーターのアドレスが書かれている。
- 次に配送すべきルーターのアドレスが記載されている場所に、そのホストやルーター自身のネットワークインタフェースの IP アドレスが書かれている場合は、「宛先のホストが（そのNICと）同一データリンクに接続されている」という意味になる。
- デフォルトルート：　経路制御表に登録されているどのアドレスにもマッチしない場合の経路。0.0.0.0/0またはdefaultと記述する。
- ホストルート：　「IPアドレス/32」はホストルートと呼ばれる。何らかの都合によりネットワークアドレスによる経路制御を利用したくない場合に使われる。
- ループバックアドレス：　同じコンピュータ内部のプログラム間で通信したい場合に利用されるのがループバックアドレス。127.0.0.1というIPアドレスが使われる。

### 4.4.2 経路制御表の集約
- 大規模で高性能なネットワークを構築する場合には、経路制御表をいかにして小さく保 つかが課題の 1 つになる。

## 4.5 IPの分割処理と再構築処理
### 4.5.1 データリンクによってMTUは違う

### 4.5.2 IPデータグラムの分割処理と再構築処理
- ホストやルーターは、必要に応じてIPデータグラムの分割処理を行う。
- 分割されたIPデータグラムを元のIPデータグラムに戻す再構築処理は、終点の宛先ホストだけで行う。

### 4.5.3 経路MTU探索
- 分割処理には欠点として、ルーターの処理が重くなる点と、分割された断片の1つが失われても元のIPデータグラムのすべてが失われてしまう点がある。
- 分割処理の弊害を避けるための技術が、経路MTU探索である。
- 経路MTU探索は、経路MTU（経路に存在するデータリンクの最小値）を発見し、送信元のホストで経路MTUの大きさにデータを分割してから送信する方法。
- TCPの場合、経路MTUを利用すると、その値をもとにパケットの送信が行われるので、IPでの分割処理・再構築処理が行われなくなる。

## 4.6 IPv6

### 4.6.5 グローバルユニキャストアドレス
- 全世界で一意に決まるアドレスという意味。

### 4.6.6 リンクローカルユニキャストアドレス
- データリンクの同一リンク内で一意に決まるアドレスという意味。

### 4.6.7 ユニークローカルアドレス
- インターネットとの通信を行わない場合に利用されるアドレス。

### 4.6.8 IPv6での分割処理
- IPv6の分割処理は始点ホストでのみ行われ、ルーターは分割処理をしない。そのため経路MTU探索がほぼ必須。

## 4.7 IPv4ヘッダ
- バージョン
- ヘッダ長（IHL）：　IPヘッダ自体の大きさを表す。４オクテットを１単位とする。
- サービスタイプ（TOS）
- DSCPフィールド、ECNフィールド
- パケット長：　IPヘッダとIPデータを加えたパケット全体のオクテット長
- 識別子：　フラグメント（転送時に分割された元データの断片）を復元する際の識別子
- フラグ：　パケットの分割に関する制御
- フラグメントオフセット（FO）：　分割されたフラグメントがオリジナルデータのどこに位置していたかを示す
- 生存時間（TTL）：　何個のルーターを中継しても良いかを表す。ルーターを通過するたびに1つ減らされ、0になったらパケットは破棄される。
- プロトコル：　IPヘッダの次のヘッダのプロトコルが何であるかを示す。
- ヘッダチェックサム：　IPヘッダが壊れていないことを保証するためのもの
- 送信元IPアドレス
- 宛先IPアドレス
- オプション
- パディング
- データ

## 4.8 IPv6のヘッダフォーマット
- IPv6ではヘッダのチェックサムは、ルーターでの処理を軽減するために省略された。
- バージョン
- トラフィッククラス
- フローラベル
- ペイロードの長さ
- 次のヘッダ：　拡張ヘッダがある場合にはそのプロトコル番号が入る
- ホップリミット：　IPv4のTTLと同じ意味
- 送信元IPアドレス
- 宛先IPアドレス

### 4.8.1 IPv6拡張ヘッダ
- 拡張ヘッダは、IPv6ヘッダとTCPやUDPのヘッダの間に挿入される。
- IPパケットを分割する場合には、拡張ヘッダを使うことになる。

# 第5章 IPに関連する技術
- DNS, ARP, ICMP, DHCP

## 5.1 IPだけでは通信できない

## 5.2 DNS
### 5.2.1 IPアドレスを覚えるのはたいへん

### 5.2.2 DNSの登場
- DNSでは、ホストを管理している組織が、ホスト名とIPアドレスの関係を表すデータベースを管理できる。
- DNSで通信したいユーザーがホスト名を（ブラウザに）入力すると、自動的にホスト名やIPアドレスが登録されているデータベースサーバーが検索され、そこからIPアドレスの情報を得るようになっている。

### 5.2.3 ドメイン名の構造
- ドメイン名とは、ホストの名前や組織の名前を識別するための階層的な名前のこと（例：　kusa.ac.jp）
- ホスト名の後にその組織のドメイン名を付ける。（例： pepper.kusa.ac.jp）
- サブドメイン：　ホスト名とドメイン名の間に入れる独自のドメイン。
- ドメインの階層構造　root -> jp,uk -> ac,co
- ネームサーバー
  - ドメイン名を管理しているホストやソフトウェアのこと
  - ネームサーバーは、それぞれのドメインの階層ごとに配置される。各ネームサーバーは、下の階層のネームサーバーのIPアドレスを知っており、ルートから木構造のように結ばれている。
- リゾルバ
  - DNSに問い合わせを行うホストやソフトウェアのこと。ユーザーが利用するPCはリゾルバに当たる。

### 5.2.4 DNSによる問い合わせ
- リゾルバは、まず自分のドメイン階層のネームサーバーに問い合わせる。ネームサーバーは、自分のデータベースに情報があればそれを返すが、なければルートネームサーバーに問い合わせ処理を行う。ルートネームサーバーは、木構造をたどって自分の直下の関係するネームサーバーの情報を返す。

### 5.2.5 DNSはインターネットに広がる分散データベース
- DNSは様々な情報を管理している。

## 5.3 ARP
### 5.3.1 ARPの概要
- アドレス解決のためのプロトコル

### 5.3.2 ARPの仕組み
- IPアドレスからMACアドレスを知るために送信するのがARP要求パケット、自分のMACアドレスを教えるために返送するのがARP応答パケット
- 通常、ARPによって取得したMACアドレスは数分間キャッシュされる

### 5.3.3 IPアドレスとMACアドレスは両方とも必要？
- IPアドレスは宛先のホストまで変わらないが、データリンクの宛先はリンクごとに変わるため、両方必要

### 5.3.4 RARP
- RARPは、MACアドレスからIPアドレスを知りたい場合に使われる。
- RARPサーバーを用意する必要がある。

### 5.3.5 代理ARP
- 代理ARPを使うとルーターはARPパケットを隣のセグメントに転送できる

## 5.4 ICMP
### 5.4.1 IPを補助するICMP
- ICMPは、ネットワークが正常に動作しているかどうかの確認や、トラブルシューティングに使われる。
- ICMPには、大きく分類すると、エラー通知のためのエラーメッセージと診断などを行う問い合わせのメッセージの2種類がある。

### 5.4.2 主なICMPメッセージ
- ICMP到達不能メッセージ（タイプ３）
- ICMPリダイレクトメッセージ（タイプ５）
  - 送信元ホストが最適でない経路を使用しているのをルーターが検出した時に、そのホストに対して送るメッセージ。最適経路情報と元のデータグラムを含む。
- ICMP時間超過メッセージ（タイプ１１）
  - tracerouteは、ICMP時間超過メッセージを応用して、どのようなルーターを通過するかを表示してくれるプログラム
- ICMPエコーメッセージ（タイプ0,8）
  - 通信したいホストやルーターに、IPパケットが到達するかどうかを確認したいときに利用される
  - ping

### 5.4.3 そのほかのICMPメッセージ

### 5.4.4 ICMPv6
- ICMPv6の役割
  - ICMPv6がなければ、IPv6による通信ができないくらいに役割が重要になっている。
  - 特に、IPアドレスからMACアドレスを調べるプロトコルが、ICMPの近隣探索メッセージに変更されている。
- 近隣探索
  - IPv6アドレスとMACアドレスの対応関係を調べるときに、近隣養成メッセージでMACアドレスを問い合わせ、近隣告知メッセージでMACアドレスを通知してもらう。

## 5.5 DHCP
### 5.5.1 プラグ&プレイを可能にするDHCP
- IPアドレスの設定を自動化したり、配布するIPアドレスの一括管理を行ったりするためにDHCPが利用される。
- 管理者がDHCPサーバーに適切な設定をしておけば、ユーザーはネットワークに接続するだけでTCP/IPでの通信に必要な設定が自動的に行われる。

### 5.5.2 DHCPの仕組み
- DHCPサーバーに障害が発生するとそのセグメント内のホストがすべて通信不能になり困るので、複数のDHCPサーバーを起動することが奨励されている。しかし、複数のDHCPサーバーがを起動すると、すでに配布されたIPアドレスを別のホストに割り当ててしまうような問題が生じる可能性がある。
- そのため、DHCPサーバーはIPアドレス配布前に、そのIPが使われていないかどうかをICMPエコー要求で確認し、DHCPクライアント側も、配布されたIPアドレスに対してARP要求パケットを送ることで使われていないことを確認するようになっている。

### 5.5.3 DHCPリレーエージェント
- 複数セグメントを有するネットワーク環境では、それぞれのセグメントごとにDHCPサーバーを配置するのは大変なので、DHCPの設定を一元管理する方法として、DHCPリレーエージェントを使ったDHCPの運用方法がある。
- 設定を一元管理するDHCPサーバーと、セグメントごとにDHCPリレーエージェントを用意する。DHCPクライアントはリレーエージェントにDHCP要求パケットなどを送付したら、リレーエージェントがDHCPサーバーに問い合わせて、設定情報を返す。

## 5.6 NAT
### 5.6.1 NATとは
- ローカルなネットワークでプライベート IP アドレスを使用し、インターネットへ接続するときにグローバルIPアドレスへ変換する技術

### 5.6.2 NATの仕組み
- NAPT：　ポート番号も変換する

### 5.6.3 NAT-PT(NAPT-PT)
- IPv6ヘッダとIPv4ヘッダを付け替える技術

### 5.6.4 NATの問題点
- NATの外側から内側のサーバーに接続することはできない　など

### 5.6.5 NATの問題点の解決とNAT越え
- 問題点の解決方法は主に2つある
  1. IPv6を使う
  2. NATがある環境を前提にアプリケーションを作成することにより、NATがあってもユーザーはそのことを意識することなく通信できるようにする方法　NAT越え

## 5.7 IPトンネリング
- ネットワーク層のヘッダの次にまたネットワーク層（や下位層）のヘッダが続く通信方法がIPトンネリング
- 例えば、ネットワークA,B,Cと繋がっていて、A,CではIPv6、BではIPv4が使われているときに、AとC間で通信するためなどに使われる。この場合、IPv4ネットワークでIPv6パケットを送ることになる。

## 5.8 その他のIP関連技術
### 5.8.1 IPマルチキャスト関連技術
- IGMP, MLD

### 5.8.2 IPエニーキャスト
- 同じサービスを提供するサーバーに同じIPアドレスをつけて、クライアントは最寄りのサーバーと通信できるようにする方法。

### 5.8.3 通信品質の制御
- 通信の品質とは
  - IPプロトコルのようなベストエフォート型の通信では、通信回線が混雑すると通信性能が極端に低下するという問題がある。
- 通信品質を制御する仕組み
  - 通信品質を保証したいパケットについてはルーターなどで特別扱いをして、優先的に処理するような制御を行う
  - IntServ, DiffServ
- IntServ
  - 特定のアプリケーション間の通信に対して通信品質の制御を提供する仕組み
  - RSVP
  - 難点がある
- DiffServ
  - 特定のネットワーク内でおおざっぱに通信品質を制御するのが目的
  - DiffServドメイン
  - DSCPフィールド
  - プロバイダとの契約ごとに大雑把な品質制御を行うため、処理がしやすく実用的な仕組み

### 5.8.4 明示的なふくそう通知
- ECN： IPパケットを使った明示的なふくそう通知機能
- ふくそう検知はネットワーク層で行い、ふくそう通知はトランスポート層で行う

### 5.8.5 Mobili IP
- Mobile IPとは
  - ホストが接続しているサブネットが変わってもIPアドレスが変わらないようにする技術
- IPトンネリングとMobile IP
- Mobile IPv6

# 第6章 TCPとUDP
## 6.1 トランスポート層の役割
### 6.1.1 トランスポート層とは
- トランスポート層は、通信する「プログラム」を指定する役割を持つ。そのためにポート番号という識別子を使う。ポート番号により、トランスポート層の上位層のアプリケーション層の処理を行うプログラムを識別する。

### 6.1.2 通信の処理
- 前述の「プログラム」はアプリケーション層の処理を行う。
- サーバー側で、サーバープログラムはあらかじめ起動させておく。これらはUNIXではデーモンと呼ぶ。
- UNIXでは個々のデーモンを別々に動かすのではなく、代表としてクライアントからの要求を待つinetd(インターネットデーモン)というスーパーデーモンが使われる。

### 6.1.3 2つのトランスポートプロトコルTCPとUDP
- TCP：　コネクション指向で、信頼性のあるプロトコル。順序制御や再送制御を行う
- UDP：　信頼性のないデータグラム型のプロトコル。

### 6.1.4 TCPとUDPの使い分け
- TCP：　信頼性のある通信を実現する必要がある場合に使われる
- UDP：　高速性やリアルタイム性を重視する通信や同報通信などに利用される。マルチキャストやブロードキャストの通信にもUDPが使われる。

## 6.2 ポート番号
### 6.2.1 ポート番号とは
- ポート番号は、同一のコンピュータ内で通信を行っているプログラムを識別するときに利用される。プログラムのアドレスということもできる。

### 6.2.2 ポート番号によるアプリケーションの識別

### 6.2.3 IPアドレスとポート番号とプロトコル番号による通信の識別
- TCP(UDP)/IPによる通信では、「宛先IPアドレス」、「送信元IPアドレス」、「宛先ポート番号」、「送信元ポート番号」、「プロトコル番号（TCPかUDPか）」の5つの数字の組み合わせで通信を識別する。（これらが異なると別の通信として、サーバー側では別々のデーモンが起動される？）

### 6.2.4 ポート番号の決め方
- 決め方には2種類ある
- 標準で決められている番号
  - HTTPなどはあらかじめ使用するポート番号が決められている。ウェルノウンポート番号　0~1023
  - ウェルノウンポート番号以外にも、1024~49151が正式に登録されているポート番号
  - これらのポート番号は多くの場合、サーバー側で使われるポート番号である。
- ダイナミックな割り当て法
  - クライアント側では、クライアントアプリケーションのポート番号の割り当てをOSが動的に管理する。
  - 動的に割り当てるポート番号は、49152~65535までの整数が利用される。

### 6.2.5 ポート番号とプロトコル
- ポート番号は使用されるトランスポートプロトコルごとに決定される。
- ウェルノウンポート番号はトランスポートプロトコルに関係なく、同じ番号が同じアプリケーションに割り当てられる。（例えば、53番のポート番号は、TCPでもUDPでもDNSに利用される。）

## 6.3 UDP
### 6.3.1 UDPの目的と特徴
- コネクションレスの通信サービスを提供する。しかも、アプリケーションから送信要求のあったデータを、送信要求のあったタイミングで、そのままネットワークに流す。
- また、再送制御などを行いたい場合、UDPを利用するアプリケーションプログラム側で行わなければならない。

## 6.4 TCP
- TCP は UDP と大きく異なり、データを送信するときの制御機能が充実していて、信頼性の高い通信を実現することができる。

#### コネクション
- コネクション：　通信を行う2つのアプリケーションが、情報の伝達のために専有して使用する仮想的な通信路
- 一度コネクションを確立すると、通信を行うアプリケーションはこの仮想的な通信路を使って情報を送受信するだけで、情報伝達の保証を得ることになる。TCPは、このコネクションの確立や終了といった管理を行う。

### 6.4.1 TCPの目的と特徴
- チェックサム、シーケンス番号、確認応答、再送制御、コネクション管理、ウィンドウ制御

### 6.4.2 シーケンス番号と確認応答で信頼性を提供
- 受信ホストは送信ホストにデータの到達を知らせる。これが確認応答（ACK）である。
- ある一定時間内に送信ホスト側に確認応答が返ってこない場合には、データが喪失したと判断してもう一度同じデータを送信する。（再送制御）
- 確認応答パケットが途中で失われた場合でも、送信ホスト側はデータを再送することになる。受信側ではデータが重複するので、後から来たデータは破棄する。（重複制御）
- これらの確認応答処理や再送制御、重複制御などは、すべてシーケンス番号を使って行われる。
- シーケンス番号は、送信するデータ１オクテットごとに付けられる連続した番号。受信側では、受信したデータパケットのTCPヘッダに書き込まれているシーケンス番号とデータ長を調べ、次に自分が受診すべき番号を確認応答として返送する。

### 6.4.3 再送タイムアウトの決定
- 再送せずに確認応答の到着を待つ時間を再送タイムアウト時間という。
- この時間を動的に適切に決めるために、パケット送信のたびにラウンドトリップ時間（往復時間。パケットを送信してからその確認応答が返るまでの時間？）とその揺らぎを計算し、それらを合計した値よりも少し大きな値を再送タイムアウト時間にする。
- 再送しても確認応答されない場合、もう一度送信するが、待つ時間を２倍、４倍と指数関数的に増やす。
- 特定の回数再送を送り返しても確認応答がない場合、強制的にコネクションを切断し、アプリケーションに異常終了を知らせる。

### 6.4.4 コネクション管理
- データ通信に先立って、通信相手との間で通信を始める準備をしてから通信を行う。
- コネクション確立要求（SYN）
- コネクション切断要求（FIN）
- スリーウェイハンドシェーク
- TCPではこのコネクションを管理するために、TCPヘッダの制御用のフィールドを利用する。

### 6.4.5 TCPはセグメント単位でデータを送信
- TCPではコネクションの確立時に、通信を行うデータ単位を決定する。これを最大セグメント長（MSS）と呼ぶ。
- 送受信ホストは、TCPヘッダにMSSオプションをつけ、自分のインタフェースに適したMSSを通知し、小さい方の値がMSSとして利用される。

### 6.4.6 ウィンドウ制御で速度向上
- ウィンドウという概念
- 確認応答を待たずに送信できるデータの大きさをウィンドウサイズという。
- この仕組みは、送信側が大きな送受信バッファを用意し、複数のセグメントを並列に確認応答することで実現している。
- データ送信後に確認応答を受信したら、データをバッファから削除し、ウィンドウをずらす。
- スライディングウィンドウ制御

### 6.4.7 ウィンドウ制御と再送制御
- ウィンドウがある程度以上の大きさの場合は、ある確認応答が途中で失われても、次の確認応答パケットが届けば、そこまで受信側に届いていることがわかるため、すぐには再送処理はしない。
- 受信側は到着を期待しているシーケンス番号のデータが到着しない場合、今まで受信したデータの確認応答をする。送信側では、一度受け取った確認応答と同じ確認応答をさらに3回受信した場合には、セグメントが失われたと判断して再送処理を行う。タイムアウトによる再送制御に比べて高速に動作するため、高速再送制御と呼ばれる。

### 6.4.8 フロー制御（流量制御）
- TCPでは、送信側は受信側の受信能力に合わせてパケット送信量を制御する。これがフロー制御。具体的には、受信ホストが送信ホストに受信可能なデータサイズを通知するようになっていて、そのサイズを超えないようにデータを送る。このサイズがウィンドウサイズになる。

### 6.4.9 ふくそう制御（ネットワークの混雑解消)
- スロースタート
- ふくそうウィンドウ　最初はふくそうウィンドウを１セグメントに設定してデータパケットを送信し、確認応答されるたびに１セグメントずつふくそうウィンドウを大きくする。送信時には、相手のホストから通知されたウィンドウとふくそうウィンドウを比較し、小さい方の値以下になるようにウィンドウを調節する。
- スロースタート閾値　この閾値を超えたときにはふくそうウィンドウの増加率をある式に従い抑制する。スロースタート閾値は、タイムアウトによる再送が発生したときに、その時のふくそうウィンドウの半分の大きさに設定される。
- TCPのスループットの特性は、徐々にネットワークの帯域を奪うようなイメージになる。

### 6.4.10 ネットワークの利用効率を高める仕組み
- Nagleアルゴリズム
- 遅延確認応答　データを受信してもすぐに確認応答せずに遅延させる方法
- ピギーバック　データの送信と確認応答を1つのTCPパケットで行うこと

### 6.4.11 TCPを利用するアプリケーション
- データの転送量が比較的多く、信頼性を必要としているが難しいことをできるだけ考えたくない場合には、TCPを使うのが良い。アプリケーションが細かい制御をした方が良い場合にはUDPを使うのが良い。

## 6.5 その他のトランスポートプロトコル
### 6.5.1 UDP-Lite
### 6.5.2 SCTP
### 6.5.3 DCCP

## 6.6 UDPヘッダのフォーマット
- 送信元ポート番号
- 宛先ポート番号
- パケット長
- チェックサム
  - UDP疑似ヘッダ

## 6.7 TCPヘッダのフォーマット
- 送信元ポート番号
- 宛先ポート番号
- シーケンス番号：　送信したデータの位置を意味する
- 確認応答番号：　次に受診すべきデータのシーケンス番号を入れる
- データオフセット：　TCPヘッダの長さを表していると考えて良い
- 予約
- コントロールフラグ
  - CWR, ECE, URG, ACK, PSH, RST, SYN, FIN
- ウィンドウサイズ
- チェックサム
  - チェックサムは、途中のルーターのメモリの故障やプログラムのバグなどでデータが破壊されていないことを保証するためにあると考えられている。
- 緊急ポインタ
- オプション
